name: ðŸ—ï¸ Build and Test

on:
  workflow_call:
    inputs:
      registry:
        required: true
        type: string
      image-name:
        required: true
        type: string
      vulnerability-threshold:
        description: "Fail build if vulnerabilities of specified severity or higher are found"
        required: false
        type: string
        default: 'MEDIUM'
    outputs:
      image-digest:
        description: "Container image digest"
        value: ${{ jobs.build-container.outputs.image-digest }}
      image-uri:
        description: "Container image URI"
        value: ${{ jobs.build-container.outputs.image-uri }}
      sbom-artifact:
        description: "SBOM artifact ID"
        value: ${{ jobs.test-and-scan.outputs.sbom-artifact }}
      scan-artifact:
        description: "Baseline scan artifact ID"
        value: ${{ jobs.test-and-scan.outputs.scan-artifact }}
      patched:
        description: "Whether the image was patched"
        value: ${{ jobs.build-container.outputs.patched }}

env:
  REGISTRY: ${{ inputs.registry }}
  IMAGE_NAME: ${{ inputs.image-name }}
  VULNERABILITY_THRESHOLD: ${{ inputs.vulnerability-threshold }}

jobs:
  test-and-scan:
    runs-on: ubuntu-latest
    outputs:
      sbom-artifact: ${{ steps.upload-sbom.outputs.artifact-id }}
      scan-artifact: ${{ steps.upload-scan.outputs.artifact-id }}
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸŽ¯ Initialize Test & Scan Phase
      uses: ./.github/actions/security-reporter
      with:
        phase: "test-start"
        title: "ðŸ§ª Test & Security Scan Phase"
    
    - name: Set up Python
      uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a
      with:
        version: "1.7.1"
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: ðŸ“¦ Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: |
        poetry install --no-interaction
        echo "### ðŸ“¦ Dependencies Installed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Python dependencies installed successfully with Poetry" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ”’ Verify lock file integrity
      run: |
        poetry check --lock 
        echo "### ðŸ”’ Lock File Verification" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Poetry lock file integrity verified" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ§ª Run tests
      run: |
        echo "### ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        poetry run pytest tests/ -v --tb=short > test_results.txt 2>&1 || TEST_FAILED=1
        
        if [ "${TEST_FAILED}" == "1" ]; then
          echo "âŒ **Tests Failed**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          tail -20 test_results.txt >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
          TEST_COUNT=$(grep -c "PASSED\|FAILED\|ERROR" test_results.txt || echo "0")
          PASSED_COUNT=$(grep -c "PASSED" test_results.txt || echo "0")
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Total Tests | $TEST_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | $PASSED_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | 0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ðŸ” Run linters and security checks
      run: |
        echo "### ðŸ” Code Quality & Security Checks" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Black formatting check
        if poetry run black --check src/ tests/ > black_results.txt 2>&1; then
          echo "âœ… **Code Formatting (Black)**: All files properly formatted" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Code Formatting (Black)**: Some files need formatting" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>View formatting issues</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          cat black_results.txt >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi
        
        # MyPy type checking
        if poetry run mypy src/ > mypy_results.txt 2>&1; then
          echo "âœ… **Type Checking (MyPy)**: No type errors found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Type Checking (MyPy)**: Type issues detected" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>View type checking results</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          cat mypy_results.txt >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Security audit
        poetry run pip-audit --format=json --output=audit-results.json
        VULN_COUNT=$(jq '.vulnerabilities | length' audit-results.json 2>/dev/null || echo "0")
        
        if [ "$VULN_COUNT" -eq 0 ]; then
          echo "âœ… **Security Audit (pip-audit)**: No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Security Audit (pip-audit)**: $VULN_COUNT vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>View vulnerability details</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```json" >> $GITHUB_STEP_SUMMARY
          jq '.vulnerabilities[] | {package: .package.name, vulnerability: .vulnerability.id, description: .vulnerability.description}' audit-results.json >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“‹ Generate SBOM with enhanced metadata
      run: |
        poetry run python scripts/generate_sbom.py > sbom.json
        SBOM_HASH=$(sha256sum sbom.json | cut -d' ' -f1)
        
        # Enhanced SBOM summary
        echo "### ðŸ“‹ Software Bill of Materials (SBOM)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        COMPONENT_COUNT=$(jq '.components | length' sbom.json 2>/dev/null || echo "0")
        DIRECT_DEPS=$(jq '.components | map(select(.scope == "required")) | length' sbom.json 2>/dev/null || echo "0")
        DEV_DEPS=$(jq '.components | map(select(.scope == "optional")) | length' sbom.json 2>/dev/null || echo "0")
        
        echo "| ðŸ“Š SBOM Metrics | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“¦ Total Components | $COMPONENT_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ Direct Dependencies | $DIRECT_DEPS |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ› ï¸ Dev Dependencies | $DEV_DEPS |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” SBOM Hash | \`${SBOM_HASH:0:12}...\` |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… SBOM generated with $COMPONENT_COUNT components" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: Upload SBOM
      id: upload-sbom
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: sbom-${{ github.sha }}
        path: sbom.json
        retention-days: 90

    - name: ðŸ›¡ï¸ Run baseline Trivy scan
      uses: aquasecurity/trivy-action@dc5a429b52fcf669ce959baa2c2dd26090d2a6c4
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'baseline-scan.json'

    - name: ðŸ“Š Process baseline scan results
      uses: ./.github/actions/security-reporter
      with:
        phase: "scan-results"
        scan-file: "baseline-scan.json"
        title: "ðŸ›¡ï¸ Baseline Security Scan Results"

    - name: Upload baseline scan results
      id: upload-scan
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
      with:
        name: baseline-scan-${{ github.sha }}
        path: baseline-scan.json
        retention-days: 30

    - name: ðŸŽ¯ Complete Test Phase
      uses: ./.github/actions/security-reporter
      with:
        phase: "test-complete"
        title: "âœ… Test & Scan Phase Complete!"

  build-container:
    needs: test-and-scan
    runs-on: ubuntu-latest
    outputs:
      image-digest: ${{ steps.final-image.outputs.digest }}
      image-uri: ${{ steps.final-image.outputs.uri }}
      patched: ${{ steps.vulnerability-scan.outputs.needs_patching }}
      
    steps:
    - uses: actions/checkout@v4
    
    - name: ðŸ—ï¸ Initialize Build Phase
      run: |
        echo "## ðŸ—ï¸ Container Build & Patching Phase" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Building secure container image with vulnerability patching and SLSA provenance**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Install Cosign
      uses: sigstore/cosign-installer@d58896d6a1865668819e1d91763c7751a165e159
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435

    - name: Install Trivy
      run: |
        sudo mkdir -p /usr/local/bin/
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
        trivy --version

    - name: Install Copa
      run: |
        # Determine system architecture
        ARCH=$(uname -m)
        case $ARCH in
          x86_64)
            ARCH_NAME="amd64"
            ;;
          aarch64)
            ARCH_NAME="arm64"
            ;;
          *)
            echo "Unsupported architecture: $ARCH"
            exit 1
            ;;
        esac

        # Create temp directory for downloads
        TEMP_DIR=$(mktemp -d)
        cd $TEMP_DIR

        # Download the latest release
        curl -L -o copa.tar.gz $(curl -s https://api.github.com/repos/project-copacetic/copacetic/releases/latest | \
          grep "browser_download_url.*linux_${ARCH_NAME}.tar.gz\"" | \
          cut -d : -f 2,3 | \
          tr -d \")

        # Install Copa
        tar xzf copa.tar.gz
        sudo chmod +x copa
        sudo mv copa /usr/local/bin/
        cd -
        rm -rf $TEMP_DIR

        # Verify installation
        copa -h
        
        echo "### ðŸ› ï¸ Security Tools Installed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Trivy**: Container vulnerability scanner" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Copa**: Container vulnerability patcher" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
      
    - name: Log in to Container Registry
      uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@c1e51972afc2121e065aed6d45c65596fe445f3f
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix=sha-,enable={{is_default_branch}}
          type=raw,value=latest,enable={{is_default_branch}}
          type=semver,pattern={{version}}
    
    - name: ðŸ› ï¸ Build and push initial Docker image
      id: build
      uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
        provenance: false  # We'll generate SLSA provenance separately

    - name: ðŸ” Scan image for vulnerabilities
      id: vulnerability-scan
      run: |
        # Get the primary tag for scanning
        PRIMARY_TAG=$(echo "${{ steps.meta.outputs.tags }}" | head -n1)
        IMAGE_REF="${PRIMARY_TAG}"
        
        echo "ðŸ” Scanning image: $IMAGE_REF" >> $GITHUB_STEP_SUMMARY
        
        # Scan and save results
        SCAN_RESULT_FILE="container-scan.json"
        trivy image \
          --vuln-type os \
          --ignore-unfixed \
          --scanners vuln --db-repository public.ecr.aws/aquasecurity/trivy-db:2 \
          -f json \
          -o ${SCAN_RESULT_FILE} \
          ${IMAGE_REF}

        # Check for vulnerabilities meeting threshold
        if trivy image \
          --vuln-type os \
          --ignore-unfixed \
          --scanners vuln --db-repository public.ecr.aws/aquasecurity/trivy-db:2 \
          --exit-code 1 \
          --severity ${{ env.VULNERABILITY_THRESHOLD }} \
          ${IMAGE_REF} > vuln_check.txt 2>&1; then
          echo "needs_patching=false" >> $GITHUB_OUTPUT
          echo "âœ… **No ${{ env.VULNERABILITY_THRESHOLD }} vulnerabilities found**" >> $GITHUB_STEP_SUMMARY
        else
          echo "needs_patching=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ **${{ env.VULNERABILITY_THRESHOLD }} vulnerabilities detected - patching required**" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Count vulnerabilities by severity
        CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' ${SCAN_RESULT_FILE} 2>/dev/null || echo "0")
        HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' ${SCAN_RESULT_FILE} 2>/dev/null || echo "0")
        MEDIUM_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' ${SCAN_RESULT_FILE} 2>/dev/null || echo "0")
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Container Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸš¨ Severity | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”´ Critical | $CRITICAL_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ  High | $HIGH_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ¡ Medium | $MEDIUM_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ Threshold | ${{ env.VULNERABILITY_THRESHOLD }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "image_ref=$IMAGE_REF" >> $GITHUB_OUTPUT

    - name: ðŸ©¹ Patch vulnerabilities with Copa
      if: steps.vulnerability-scan.outputs.needs_patching == 'true'
      id: patch
      run: |
        IMAGE_REF="${{ steps.vulnerability-scan.outputs.image_ref }}"
        PATCHED_IMAGE="${IMAGE_REF}-patched"
        
        echo "ðŸ©¹ Patching vulnerabilities in: $IMAGE_REF" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Patch the image using Copa
        if copa patch \
          -r container-scan.json \
          --image ${IMAGE_REF} \
          --tag ${PATCHED_IMAGE}; then
          
          echo "âœ… **Image patched successfully**" >> $GITHUB_STEP_SUMMARY
          
          # Re-tag and push all original tags to point to patched image
          TAGS="${{ steps.meta.outputs.tags }}"
          PATCHED_DIGEST=""
          
          for tag in $TAGS; do
            echo "ðŸ·ï¸ Re-tagging: $tag -> patched image"
            docker tag ${PATCHED_IMAGE} $tag
            # Capture digest from the first push
            if [ -z "$PATCHED_DIGEST" ]; then
              PUSH_OUTPUT=$(docker push $tag 2>&1)
              PATCHED_DIGEST=$(echo "$PUSH_OUTPUT" | grep -o 'sha256:[a-f0-9]\{64\}' | head -1)
            else
              docker push $tag
            fi
          done
          
          echo "patched_image=$PATCHED_IMAGE" >> $GITHUB_OUTPUT
          echo "patching_successful=true" >> $GITHUB_OUTPUT
          echo "patched_digest=$PATCHED_DIGEST" >> $GITHUB_OUTPUT
          
        else
          echo "âŒ **Patching failed - proceeding with original image**" >> $GITHUB_STEP_SUMMARY
          echo "patched_image=" >> $GITHUB_OUTPUT
          echo "patching_successful=false" >> $GITHUB_OUTPUT
          echo "patched_digest=" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ” Final vulnerability verification
      if: steps.vulnerability-scan.outputs.needs_patching == 'true'
      run: |
        IMAGE_REF="${{ steps.vulnerability-scan.outputs.image_ref }}"
        
        echo "### ðŸ” Post-Patch Vulnerability Verification" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Scan the final image
        trivy image \
          --vuln-type os \
          --ignore-unfixed \
          --scanners vuln --db-repository public.ecr.aws/aquasecurity/trivy-db:2 \
          -f json \
          -o final-scan.json \
          ${IMAGE_REF}
        
        # Count remaining vulnerabilities
        REMAINING_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' final-scan.json 2>/dev/null || echo "0")
        REMAINING_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' final-scan.json 2>/dev/null || echo "0")
        
        echo "| ðŸ” Post-Patch Status | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|---------------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”´ Critical Remaining | $REMAINING_CRITICAL |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŸ  High Remaining | $REMAINING_HIGH |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Final threshold check
        if trivy image \
          --vuln-type os \
          --ignore-unfixed \
          --scanners vuln --db-repository public.ecr.aws/aquasecurity/trivy-db:2 \
          --exit-code 1 \
          --severity ${{ env.VULNERABILITY_THRESHOLD }} \
          ${IMAGE_REF}; then
          echo "âœ… **Final image meets security threshold**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Warning: Final image still contains ${{ env.VULNERABILITY_THRESHOLD }} vulnerabilities**" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“Š Set final image details
      id: final-image
      run: |
        # Determine final image and digest based on patching results
        if [ "${{ steps.vulnerability-scan.outputs.needs_patching }}" == "true" ] && [ "${{ steps.patch.outputs.patching_successful }}" == "true" ]; then
          # Use patched image digest
          FINAL_DIGEST="${{ steps.patch.outputs.patched_digest }}"
          FINAL_IMAGE="${{ steps.vulnerability-scan.outputs.image_ref }}"
          echo "ðŸ©¹ Using patched image" >> $GITHUB_STEP_SUMMARY
        else
          # Use original build digest
          FINAL_DIGEST="${{ steps.build.outputs.digest }}"
          FINAL_IMAGE="${{ steps.vulnerability-scan.outputs.image_ref }}"
          if [ "${{ steps.vulnerability-scan.outputs.needs_patching }}" == "true" ]; then
            echo "âš ï¸ Using original image (patching failed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Using original image (no patching needed)" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        
        # Validate digest format
        if [[ ! "$FINAL_DIGEST" =~ ^sha256:[a-f0-9]{64}$ ]]; then
          echo "âŒ Invalid digest format: $FINAL_DIGEST"
          exit 1
        fi
        
        echo "digest=$FINAL_DIGEST" >> $GITHUB_OUTPUT
        echo "uri=$FINAL_IMAGE" >> $GITHUB_OUTPUT
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Final Image Details" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“‹ Property | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ·ï¸ Image URI | \`$FINAL_IMAGE\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” Digest | \`${FINAL_DIGEST:0:19}...\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ©¹ Patched | ${{ steps.vulnerability-scan.outputs.needs_patching }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ” Sign container image with private key
      env:
        COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      run: |
        IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.final-image.outputs.digest }}"
        echo "ðŸ” Signing final container image: $IMAGE_REF" >> $GITHUB_STEP_SUMMARY
        
        if cosign sign --yes --key env://COSIGN_PRIVATE_KEY "$IMAGE_REF"; then
          echo "âœ… **Container image signed successfully with Cosign**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Container signing failed - proceeding with unsigned image**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“œ Generate GitHub Attestations
      uses: actions/attest-build-provenance@e8998f949152b193b063cb0ec769d69d929409be
      id: attest
      with:
        subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        subject-digest: ${{ steps.final-image.outputs.digest }}

    - name: ðŸŽ¯ Complete Build Phase
      run: |
        echo "### ðŸŽ‰ Container Build Phase Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Container built, scanned, and secured**" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.vulnerability-scan.outputs.needs_patching }}" == "true" ]; then
          echo "ðŸ©¹ **Vulnerabilities automatically patched**" >> $GITHUB_STEP_SUMMARY
        fi
        echo "ðŸ” **Container signed and attested**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“œ **GitHub attestations generated**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
