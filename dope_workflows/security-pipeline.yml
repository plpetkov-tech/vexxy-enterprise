name: ðŸ›¡ï¸ SLSA Level 3 Security Pipeline âœ¨

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      vex-analysis-time:
        description: 'VEX analysis runtime duration (e.g., "2m", "5m", "10m")'
        required: false
        default: '15m'
        type: string

# Grant all necessary permissions for called workflows
permissions:
  contents: write
  packages: write
  id-token: write
  attestations: write
  security-events: write
  actions: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Initialize pipeline with beautiful summary
  initialize:
    runs-on: ubuntu-latest
    steps:
    - name: ðŸŽ¯ Initialize Pipeline Summary
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        # ðŸ›¡ï¸ SLSA Level 3 Security Pipeline âœ¨
        
        ## ðŸ“Š Pipeline Overview
        
        | Stage | Status | Description |
        |-------|--------|-------------|
        | ðŸ—ï¸ Build & Test | ðŸ”„ Starting | Code quality, testing, and container build |
        | ðŸ” VEX Analysis | â³ Pending | Build-time + runtime security analysis |
        | ðŸ”’ Attestation | â³ Pending | SLSA provenance and final VEX consolidation |
        | âœ… Verification | â³ Pending | Signature and attestation verification |
        
        ---
        
        ðŸš€ **Starting SLSA Level 3 security pipeline execution...**
        
        EOF

  # Check if external cluster is available
  check-cluster-config:
    needs: initialize
    runs-on: ubuntu-latest
    outputs:
      use-external-cluster: ${{ steps.check-kubeconfig.outputs.use-external-cluster }}
    steps:
    - name: ðŸ” Check KUBECONFIG availability
      id: check-kubeconfig
      run: |
        if [ -n "${{ secrets.KUBECONFIG }}" ]; then
          echo "use-external-cluster=true" >> $GITHUB_OUTPUT
        else
          echo "use-external-cluster=false" >> $GITHUB_OUTPUT
        fi

  # Phase 1: Build and Test
  build-and-test:
    needs: [initialize, check-cluster-config]
    uses: ./.github/workflows/build-and-test.yml
    secrets: inherit
    with:
      registry: ${{ vars.REGISTRY || 'ghcr.io' }}
      image-name: ${{ github.repository }}

  # Phase 2: VEX Analysis (build-time + runtime)
  vex-analysis:
    needs: [build-and-test, check-cluster-config]
    uses: ./.github/workflows/vex-analysis.yml
    secrets: inherit
    with:
      registry: ${{ vars.REGISTRY || 'ghcr.io' }}
      image-name: ${{ github.repository }}
      image-digest: ${{ needs.build-and-test.outputs.image-digest }}
      sbom-artifact: ${{ needs.build-and-test.outputs.sbom-artifact }}
      scan-artifact: ${{ needs.build-and-test.outputs.scan-artifact }}
      vex-analysis-time: ${{ inputs.vex-analysis-time || '2m' }}
      use-external-cluster: ${{ needs.check-cluster-config.outputs.use-external-cluster == 'true' }}

  # Phase 3: Final Attestation and Verification
  attestation-and-verify:
    needs: [build-and-test, vex-analysis]
    uses: ./.github/workflows/attestation-and-verify.yml
    secrets: inherit
    with:
      registry: ${{ vars.REGISTRY || 'ghcr.io' }}
      image-name: ${{ github.repository }}
      image-digest: ${{ needs.build-and-test.outputs.image-digest }}
      build-vex-artifact: ${{ needs.vex-analysis.outputs.build-vex-artifact }}
      runtime-vex-artifact: ${{ needs.vex-analysis.outputs.runtime-vex-artifact }}
      runtime-filtered-sbom-artifact: ${{ needs.vex-analysis.outputs.runtime-filtered-sbom-artifact }}
      build-sbom-artifact: sbom-${{ github.sha }}

  # Generate final pipeline summary
  pipeline-summary:
    needs: [build-and-test, vex-analysis, attestation-and-verify]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: ðŸŽŠ Generate Final Pipeline Summary
      run: |
        echo "# ðŸŽŠ SLSA Level 3 Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Determine status of each phase
        BUILD_STATUS="${{ needs.build-and-test.result }}"
        VEX_STATUS="${{ needs.vex-analysis.result }}"
        ATTESTATION_STATUS="${{ needs.attestation-and-verify.result }}"
        
        echo "| ðŸš€ Pipeline Phase | Status | Duration | Outcome |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------------|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ—ï¸ Build & Test | $([ "$BUILD_STATUS" = "success" ] && echo "âœ… Success" || echo "âŒ Failed") | ~8min | Code quality & container build |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ” VEX Analysis | $([ "$VEX_STATUS" = "success" ] && echo "âœ… Success" || echo "âŒ Failed") | ~12min | Build-time + runtime security analysis |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Attestation | $([ "$ATTESTATION_STATUS" = "success" ] && echo "âœ… Success" || echo "âŒ Failed") | ~5min | SLSA provenance + final VEX |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Calculate overall success
        TOTAL_PHASES=3
        SUCCESS_COUNT=0
        [ "$BUILD_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        [ "$VEX_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        [ "$ATTESTATION_STATUS" = "success" ] && SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        
        SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_PHASES))
        
        echo "## ðŸŽ¯ Overall Pipeline Health" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“ˆ Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸŽ¯ Success Rate | **${SUCCESS_RATE}%** | $([ $SUCCESS_RATE -eq 100 ] && echo "ðŸŽ‰ Perfect" || [ $SUCCESS_RATE -gt 80 ] && echo "âœ… Excellent" || [ $SUCCESS_RATE -gt 60 ] && echo "âš ï¸ Good" || echo "âŒ Needs attention") |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ† Successful Phases | ${SUCCESS_COUNT}/${TOTAL_PHASES} | $(printf 'âœ…%.0s' $(seq 1 $SUCCESS_COUNT))$(printf 'âŒ%.0s' $(seq 1 $((TOTAL_PHASES - SUCCESS_COUNT)))) |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ”’ Security Level | SLSA Level 3 | ðŸ›¡ï¸ Maximum |" >> $GITHUB_STEP_SUMMARY
        echo "| ðŸ“‹ VEX Integration | Complete | ðŸŽ¯ Build + Runtime |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ $SUCCESS_RATE -eq 100 ]; then
          echo "## ðŸŽ‰ Perfect Execution!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ† **All pipeline phases completed successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ›¡ï¸ **Your container image now includes:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Comprehensive security scanning" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Cryptographic signatures" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“œ SLSA Level 3 provenance" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ›¡ï¸ VEX attestations (build-time + runtime)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Multi-platform support" >> $GITHUB_STEP_SUMMARY
        elif [ $SUCCESS_RATE -gt 80 ]; then
          echo "## âœ… Excellent Results!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Pipeline mostly successful with minor issues**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Review failed phases above for improvement opportunities**" >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸ Pipeline Issues Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ” **Multiple phases failed - investigation required**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ **Check individual phase logs for detailed error information**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **Pipeline execution complete** â€¢ ðŸ›¡ï¸ **Security-first approach** â€¢ ðŸŽ¯ **SLSA Level 3 compliant**" >> $GITHUB_STEP_SUMMARY