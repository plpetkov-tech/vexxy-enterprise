# .github/workflows/security-monitoring.yml
name: Security Monitoring

on:
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Trivy
        uses: aquasecurity/setup-trivy@9ea583eb67910444b1f64abf338bd2e105a0a93d
        with:
          version: v0.61.0
          cache: true

      - name: Get latest successful workflow run
        id: get-run
        run: |
          echo "ðŸ” Searching for previous successful workflow run..."
          
          # Get the latest successful workflow run (excluding current run)
          LATEST_RUN=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/workflows/security-monitoring.yml/runs?status=success&per_page=1" \
            --jq '.workflow_runs[0].id')
          
          if [ "$LATEST_RUN" != "null" ] && [ "$LATEST_RUN" != "" ]; then
            echo "previous-run-id=$LATEST_RUN" >> $GITHUB_OUTPUT
            echo "âœ… Found previous successful run: #$LATEST_RUN"
            echo "ðŸ“¥ Will attempt to download previous scan artifact"
          else
            echo "ðŸ†• No previous successful run found - this is likely the first run"
            echo "ðŸš€ Will perform initial baseline scan"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download previous scan artifact (if exists)
        if: steps.get-run.outputs.previous-run-id
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0
        with:
          name: previous-scan
          run-id: ${{ steps.get-run.outputs.previous-run-id }}
          github-token: ${{ github.token }}
        continue-on-error: true

      - name: Rename downloaded scan file
        if: steps.get-run.outputs.previous-run-id
        run: |
          if [ -f new-scan.json ]; then
            mv new-scan.json previous-scan.json
            echo "âœ… Successfully downloaded and renamed previous scan file"
            echo "ðŸ“Š Previous scan data is ready for comparison"
          else
            echo "âš ï¸ Previous scan artifact was not found or failed to download"
            echo "ðŸ”„ Will proceed without comparison baseline"
          fi

      - name: Scan latest image
        id: scan
        run: |
          echo "ðŸ” Starting security scan of container image..."
          echo "ðŸŽ¯ Target: ghcr.io/${{ github.repository }}:latest"
          echo ""
          
          trivy image --format json --output new-scan.json \
            ghcr.io/${{ github.repository }}:latest
          
          echo ""
          echo "âœ… Security scan completed successfully!"
          
          # Quick analysis of scan results
          if [ -f new-scan.json ]; then
            TOTAL_VULNS=$(jq '[.Results[]?.Vulnerabilities // empty] | add | length' new-scan.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "CRITICAL")) | length' new-scan.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "HIGH")) | length' new-scan.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "MEDIUM")) | length' new-scan.json 2>/dev/null || echo "0")
            
            echo "ðŸ“Š Scan Results Summary:"
            echo "   ðŸ”´ Critical: $CRITICAL vulnerabilities"
            echo "   ðŸŸ  High: $HIGH vulnerabilities" 
            echo "   ðŸŸ¡ Medium: $MEDIUM vulnerabilities"
            echo "   ðŸ“ Total: $TOTAL_VULNS vulnerabilities found"
            
            if [ "$CRITICAL" -gt 0 ]; then
              echo "âš ï¸  ATTENTION: Critical vulnerabilities detected!"
            elif [ "$HIGH" -gt 0 ]; then
              echo "âš ï¸  High severity vulnerabilities found"
            else
              echo "âœ… No critical or high severity vulnerabilities detected"
            fi
          fi

      - name: Upload new scan artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: previous-scan
          path: new-scan.json
          retention-days: 90

      - name: Compare with previous scan
        id: compare
        run: |
          echo "ðŸ”„ Starting vulnerability comparison analysis..."
          echo ""
          
          if [ -f previous-scan.json ]; then
            echo "ðŸ“Š Comparing current scan with previous baseline..."
            
            python scripts/compare_scans.py \
              --previous previous-scan.json \
              --current new-scan.json \
              --output scan-diff.json \
              --verbose
            
            echo ""
            echo "ðŸ“‹ Comparison Analysis Results:"
            
            if [ -f scan-diff.json ] && [ -s scan-diff.json ]; then
              # Extract comparison statistics
              NEW_COUNT=$(jq '.comparison_metadata.new_vulnerabilities_count // 0' scan-diff.json)
              RESOLVED_COUNT=$(jq '.comparison_metadata.resolved_vulnerabilities_count // 0' scan-diff.json)
              UNCHANGED_COUNT=$(jq '.comparison_metadata.unchanged_vulnerabilities_count // 0' scan-diff.json)
              RISK_LEVEL=$(jq -r '.summary.risk_level // "UNKNOWN"' scan-diff.json)
              
              echo "   ðŸ†• New vulnerabilities: $NEW_COUNT"
              echo "   âœ… Resolved vulnerabilities: $RESOLVED_COUNT"  
              echo "   âšª Unchanged vulnerabilities: $UNCHANGED_COUNT"
              echo "   ðŸŽ¯ Risk Level: $RISK_LEVEL"
              
              # Check for new critical/high severity
              NEW_CRITICAL=$(jq '.summary.new_vulnerabilities_summary.critical // 0' scan-diff.json)
              NEW_HIGH=$(jq '.summary.new_vulnerabilities_summary.high // 0' scan-diff.json)
              
              if [ "$NEW_CRITICAL" -gt 0 ]; then
                echo "   ðŸš¨ NEW CRITICAL: $NEW_CRITICAL critical vulnerabilities detected!"
              fi
              if [ "$NEW_HIGH" -gt 0 ]; then
                echo "   âš ï¸  NEW HIGH: $NEW_HIGH high severity vulnerabilities detected!"
              fi
              
              # Set output for workflow decisions
              NEW_VULNS=$(jq -r 'if .new_vulnerabilities and (.new_vulnerabilities | length > 0) then "true" else "false" end' scan-diff.json 2>/dev/null || echo "true")
              echo "new-vulnerabilities=$NEW_VULNS" >> $GITHUB_OUTPUT
              
              if [ "$NEW_VULNS" = "true" ]; then
                echo ""
                echo "ðŸ”” Action Required: New vulnerabilities detected - VEX document will be updated"
              else
                echo ""
                echo "âœ… No new vulnerabilities found - no action required"
              fi
            else
              echo "âŒ Comparison failed or produced empty results"
              echo "new-vulnerabilities=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ðŸ†• No previous scan found - establishing baseline"
            echo '{"comparison_metadata": {"note": "Initial baseline scan"}, "new_vulnerabilities": [], "summary": {"risk_level": "BASELINE"}}' > scan-diff.json
            echo "   ðŸ“ This scan will serve as the baseline for future comparisons"
            echo "   ðŸŽ¯ All vulnerabilities in this scan are considered baseline state"
            echo "new-vulnerabilities=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: '3.11'
      
      - name: Install Poetry
        uses: snok/install-poetry@76e04a911780d5b312d89783f7b1cd627778900a
        with:
          version: "1.7.1"
          virtualenvs-create: true
          virtualenvs-in-project: true
      
      - name: Install dependencies
        run: poetry install
      
      - name: Generate enhanced SBOM (if missing)
        run: |
          if [ ! -f sbom.json ]; then
            echo "ðŸ“¦ Generating enhanced Software Bill of Materials (SBOM)..."
            echo "ðŸŽ¯ Target: Enhanced SBOM with SLSA metadata"
            
            poetry run python scripts/generate_sbom.py > sbom.json
            
            echo "âœ… Enhanced SBOM generated successfully!"
            
            # Quick SBOM analysis
            if [ -f sbom.json ]; then
              COMPONENT_COUNT=$(jq '.components | length' sbom.json 2>/dev/null || echo "0")
              echo "   ðŸ“Š Components catalogued: $COMPONENT_COUNT"
              echo "   ðŸ—ï¸ SBOM includes build metadata and SLSA context"
            fi
          else
            echo "âœ… SBOM already exists, skipping generation"
          fi

      - name: Update VEX if needed
        if: steps.compare.outputs.new-vulnerabilities == 'true'
        run: |
          echo "ðŸ”„ New vulnerabilities detected - updating VEX document..."
          echo ""
          
          # Generate VEX document
          python scripts/generate_vex.py \
            --trivy-results new-scan.json \
            --sbom sbom.json \
            --output updated-vex.json
          
          if [ -f updated-vex.json ]; then
            echo "âœ… VEX document generated successfully"
            
            # Analyze VEX content
            VEX_VULNS=$(jq '.vulnerabilities | length' updated-vex.json 2>/dev/null || echo "0")
            echo "   ðŸ“„ VEX document contains $VEX_VULNS vulnerability entries"
            
            # Create branch and commit VEX update
            BRANCH_NAME="security/vex-update-$(date +%Y%m%d-%H%M%S)"
            echo ""
            echo "ðŸŒ¿ Creating security update branch: $BRANCH_NAME"
            
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git checkout -b "$BRANCH_NAME"
            git add updated-vex.json
            git commit -m "ðŸ”’ Security: Update VEX document with new vulnerabilities
            - Updated VEX document with latest vulnerability analysis
            - Generated from security scan on $(date)
            - Contains $VEX_VULNS vulnerability entries
            - Auto-generated by security monitoring workflow"
                        
            git push origin "$BRANCH_NAME"
            echo "âœ… Security branch pushed successfully"
            
            echo ""
            echo "ðŸ“ Creating Pull Request..."
            
            # Create detailed PR body
            PR_BODY="## ðŸ”’ Security Update: VEX Document

            This automated security update contains a new VEX (Vulnerability Exploitability eXchange) document based on the latest vulnerability scan.

            ### ðŸ“Š Scan Summary
            "
            
            if [ -f scan-diff.json ]; then
              NEW_COUNT=$(jq '.comparison_metadata.new_vulnerabilities_count // 0' scan-diff.json)
              RISK_LEVEL=$(jq -r '.summary.risk_level // "UNKNOWN"' scan-diff.json)
              PR_BODY="$PR_BODY
              - **New Vulnerabilities:** $NEW_COUNT
              - **Risk Level:** $RISK_LEVEL
              - **VEX Entries:** $VEX_VULNS"
            fi
                          
            PR_BODY="$PR_BODY
            ### ðŸŽ¯ What's Changed
            - Updated \`updated-vex.json\` with latest vulnerability analysis
            - Auto-generated VEX document following CycloneDX standard
            - Includes exploitability analysis for each vulnerability

            ### ðŸ” Next Steps
            1. Review the VEX document for accuracy
            2. Validate vulnerability analysis and justifications  
            3. Merge to update security documentation
            4. Consider additional mitigation measures if needed

            ---
            ðŸ¤– *This PR was automatically created by the security monitoring workflow*"
                          
            # Create PR with detailed information
            gh pr create \
              --title "ðŸ”’ Security: Update VEX document ($(date +%Y-%m-%d))" \
              --body "$PR_BODY" \
              --head "$BRANCH_NAME" \
              --base main \
              && echo "âœ… Pull request created successfully!" \
              || {
                echo "âŒ PR creation failed - GitHub Actions bot cannot create PRs by default"
                echo "ðŸ“‹ Manual action required:"
                echo "   1. Go to: https://github.com/${{ github.repository }}/pull/new/$BRANCH_NAME"
                echo "   2. Or enable 'Allow GitHub Actions to create and approve pull requests' in repository settings"
                echo "   3. Branch '$BRANCH_NAME' is ready for PR creation"
              }
              
          else
            echo "âŒ Failed to generate VEX document"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Create Security Summary
        if: always()
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Current scan results
          if [ -f new-scan.json ]; then
            TOTAL_VULNS=$(jq '[.Results[]?.Vulnerabilities // empty] | add | length' new-scan.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "CRITICAL")) | length' new-scan.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "HIGH")) | length' new-scan.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "MEDIUM")) | length' new-scan.json 2>/dev/null || echo "0")
            LOW=$(jq '[.Results[]?.Vulnerabilities // empty] | add | map(select(.Severity == "LOW")) | length' new-scan.json 2>/dev/null || echo "0")
            
            echo "## ðŸ“Š Current Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ”´ Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ  High | $HIGH |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¡ Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŸ¢ Low | $LOW |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL_VULNS** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Comparison results
          if [ -f scan-diff.json ]; then
            NEW_COUNT=$(jq '.comparison_metadata.new_vulnerabilities_count // 0' scan-diff.json)
            RESOLVED_COUNT=$(jq '.comparison_metadata.resolved_vulnerabilities_count // 0' scan-diff.json)
            RISK_LEVEL=$(jq -r '.summary.risk_level // "UNKNOWN"' scan-diff.json)
            RECOMMENDATION=$(jq -r '.summary.recommended_action // "No recommendation available"' scan-diff.json)
            
            echo "## ðŸ”„ Comparison with Previous Scan" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **New Vulnerabilities:** $NEW_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Resolved Vulnerabilities:** $RESOLVED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Risk Level:** $RISK_LEVEL" >> $GITHUB_STEP_SUMMARY
            echo "- **Recommendation:** $RECOMMENDATION" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Action taken
          if [ "${{ steps.compare.outputs.new-vulnerabilities }}" = "true" ]; then
            echo "## ðŸŽ¯ Actions Taken" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Generated updated VEX document" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Created security update pull request" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“ Updated vulnerability analysis documentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… No Action Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No new vulnerabilities detected. Current security posture is maintained." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ðŸ¤– This summary was automatically generated by the security monitoring workflow*" >> $GITHUB_STEP_SUMMARY
