name: Premium Service Tests

permissions:
  actions: read
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches:
      - main
      - develop
      - claude/**
    paths:
      - 'premium-service/**'
      - '.github/workflows/premium-service-tests.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'premium-service/**'
      - '.github/workflows/premium-service-tests.yml'
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'premium-service/requirements*.txt'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd premium-service
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: ðŸ§ª Run unit tests with coverage
        env:
          K8S_IN_CLUSTER: "false"
          K8S_SANDBOX_NAMESPACE: vexxy-sandbox-test
          ENVIRONMENT: testing
        run: |
          cd premium-service
          pytest tests/unit/ \
            -v \
            --tb=short \
            --cov=services \
            --cov=workers \
            --cov=api \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --junit-xml=test-results.xml \
            -m "unit" \
            || echo "::warning::Some tests failed"

      - name: ðŸ“Š Generate test summary
        if: always()
        run: |
          cd premium-service

          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-results.xml ]; then
            # Parse test results
            TOTAL=$(grep -oP 'tests="\K[^"]+' test-results.xml | head -1)
            FAILURES=$(grep -oP 'failures="\K[^"]+' test-results.xml | head -1)
            ERRORS=$(grep -oP 'errors="\K[^"]+' test-results.xml | head -1)
            SKIPPED=$(grep -oP 'skipped="\K[^"]+' test-results.xml | head -1)
            PASSED=$((TOTAL - FAILURES - ERRORS - SKIPPED))

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILURES |" >> $GITHUB_STEP_SUMMARY
            echo "| âš ï¸ Errors | $ERRORS |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“Š Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ $FAILURES -eq 0 ] && [ $ERRORS -eq 0 ]; then
              echo "### âœ¨ All tests passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âš ï¸ Some tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ˆ Generate coverage summary
        if: always()
        run: |
          cd premium-service

          echo "## ðŸ“Š Code Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f coverage.xml ]; then
            # Extract coverage percentage
            COVERAGE=$(python3 << 'EOF'
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0))
          print(f"{line_rate * 100:.1f}")
          EOF
            )

            echo "**Overall Coverage:** \`${COVERAGE}%\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Coverage badge
            if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
              BADGE_COLOR="brightgreen"
              EMOJI="ðŸŸ¢"
            elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
              BADGE_COLOR="yellow"
              EMOJI="ðŸŸ¡"
            else
              BADGE_COLOR="red"
              EMOJI="ðŸ”´"
            fi

            echo "${EMOJI} Coverage: ${COVERAGE}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Per-module coverage
            echo "### Coverage by Module" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Module | Coverage |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY

            python3 << 'EOF'
          import xml.etree.ElementTree as ET
          import os

          tree = ET.parse('coverage.xml')
          root = tree.getroot()

          modules = []
          for package in root.findall('.//package'):
              name = package.get('name', 'unknown')
              line_rate = float(package.get('line-rate', 0))
              coverage_pct = line_rate * 100

              # Get emoji based on coverage
              if coverage_pct >= 80:
                  emoji = "ðŸŸ¢"
              elif coverage_pct >= 60:
                  emoji = "ðŸŸ¡"
              else:
                  emoji = "ðŸ”´"

              modules.append((name, coverage_pct, emoji))

          # Sort by coverage descending
          modules.sort(key=lambda x: x[1], reverse=True)

          # Write to summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
              for name, coverage, emoji in modules[:10]:  # Top 10 modules
                  f.write(f"| `{name}` | {emoji} {coverage:.1f}% |\n")
          EOF

          else
            echo "âš ï¸ No coverage data found" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“‹ List test files
        if: always()
        run: |
          cd premium-service

          echo "## ðŸ“ Test Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| File | Tests | Lines |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|-------|" >> $GITHUB_STEP_SUMMARY

          for file in tests/unit/test_*.py; do
            if [ -f "$file" ]; then
              TEST_COUNT=$(grep -c "^def test_" "$file" || echo 0)
              LINE_COUNT=$(wc -l < "$file")
              BASENAME=$(basename "$file")
              echo "| \`$BASENAME\` | $TEST_COUNT | $LINE_COUNT |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-unit
          path: |
            premium-service/coverage.xml
            premium-service/htmlcov/
          retention-days: 30

      - name: ðŸ“¤ Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-unit
          path: premium-service/test-results.xml
          retention-days: 30

      - name: ðŸ“Š Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: premium-service/test-results.xml
          check_name: Unit Test Results
          comment_mode: off

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'premium-service/requirements*.txt'

      - name: ðŸ“¦ Install dependencies
        run: |
          cd premium-service
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: ðŸ” Run Ruff linter
        run: |
          cd premium-service

          echo "## ðŸ” Ruff Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if ruff check . --output-format=github; then
            echo "âœ… No linting issues found!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Linting issues found (see annotations)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ¨ Run Black formatter check
        run: |
          cd premium-service

          echo "## ðŸŽ¨ Black Formatting Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if black --check . 2>&1 | tee black-output.txt; then
            echo "âœ… All files are properly formatted!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Some files need formatting:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 black-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”Ž Run MyPy type checking
        continue-on-error: true
        run: |
          cd premium-service

          echo "## ðŸ”Ž MyPy Type Checking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if mypy . 2>&1 | tee mypy-output.txt; then
            echo "âœ… No type errors found!" >> $GITHUB_STEP_SUMMARY
          else
            ERROR_COUNT=$(grep -c "error:" mypy-output.txt || echo 0)
            echo "âš ï¸ Found $ERROR_COUNT type errors" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, code-quality]
    if: always()

    steps:
      - name: ðŸ“Š Final Summary
        run: |
          echo "# ðŸŽ¯ VEXxy Premium Service - Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Job statuses
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "| Unit Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "| Code Quality | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Quality | âš ï¸ Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall result
          if [ "${{ needs.unit-tests.result }}" == "success" ] && [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "### âœ¨ All checks passed! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some checks need attention" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by VEXxy Premium Service CI*" >> $GITHUB_STEP_SUMMARY
