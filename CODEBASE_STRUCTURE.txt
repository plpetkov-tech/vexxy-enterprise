VEXxy Enterprise - Codebase Directory Structure
===============================================

/home/user/vexxy-enterprise/
â”‚
â”œâ”€â”€ README.md (Main project overview)
â”œâ”€â”€ PREMIUM_VEX_INTEGRATION_PLAN.md (Architecture planning doc)
â”œâ”€â”€ KUBESCAPE_INTEGRATION_SUMMARY.md
â”‚
â””â”€â”€ premium-service/
    â”œâ”€â”€ README.md (Service documentation)
    â”œâ”€â”€ requirements.txt (Dependencies - NO STRIPE SDK YET)
    â”œâ”€â”€ requirements-dev.txt
    â”œâ”€â”€ docker-compose.yml (Local development: API, Worker, DB, Redis, Flower)
    â”œâ”€â”€ Dockerfile (Service container image)
    â”‚
    â”œâ”€â”€ api/
    â”‚   â”œâ”€â”€ main.py (FastAPI app - 650 lines)
    â”‚   â”‚   â”œâ”€â”€ FastAPI app initialization
    â”‚   â”‚   â”œâ”€â”€ Middleware setup
    â”‚   â”‚   â”œâ”€â”€ Health check endpoint
    â”‚   â”‚   â”œâ”€â”€ POST /api/v1/analysis/submit (NEEDS AUTH)
    â”‚   â”‚   â”œâ”€â”€ GET /api/v1/analysis/{job_id}/status
    â”‚   â”‚   â”œâ”€â”€ GET /api/v1/analysis/{job_id}/results
    â”‚   â”‚   â”œâ”€â”€ DELETE /api/v1/analysis/{job_id}
    â”‚   â”‚   â”œâ”€â”€ GET /api/v1/analysis (list with pagination)
    â”‚   â”‚   â””â”€â”€ GET /api/v1/vex/{vex_id}
    â”‚   â”‚
    â”‚   â””â”€â”€ schemas.py (Pydantic models)
    â”‚       â”œâ”€â”€ JobStatusEnum
    â”‚       â”œâ”€â”€ AnalysisRequest
    â”‚       â”œâ”€â”€ AnalysisConfig
    â”‚       â”œâ”€â”€ AnalysisJobResponse
    â”‚       â”œâ”€â”€ AnalysisStatusResponse
    â”‚       â”œâ”€â”€ AnalysisResults
    â”‚       â”œâ”€â”€ ExecutionProfile
    â”‚       â”œâ”€â”€ ReachabilityResult
    â”‚       â”œâ”€â”€ SecurityAlert
    â”‚       â”œâ”€â”€ SecurityFindings
    â”‚       â””â”€â”€ HealthResponse
    â”‚
    â”œâ”€â”€ models/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ database.py
    â”‚   â”‚   â”œâ”€â”€ SQLAlchemy engine setup
    â”‚   â”‚   â”œâ”€â”€ SessionLocal factory
    â”‚   â”‚   â””â”€â”€ get_db() dependency
    â”‚   â”‚
    â”‚   â””â”€â”€ analysis.py (Database models)
    â”‚       â”œâ”€â”€ PremiumAnalysisJob
    â”‚       â”‚   â”œâ”€â”€ id, organization_id (FK - NOT CREATED YET)
    â”‚       â”‚   â”œâ”€â”€ image_ref, image_digest
    â”‚       â”‚   â”œâ”€â”€ status, priority, progress_percent
    â”‚       â”‚   â”œâ”€â”€ execution_profile (JSON)
    â”‚       â”‚   â”œâ”€â”€ reachability_results (JSON)
    â”‚       â”‚   â”œâ”€â”€ security_findings (JSON)
    â”‚       â”‚   â”œâ”€â”€ sandbox_id, sandbox_job_name
    â”‚       â”‚   â”œâ”€â”€ billed_at, cost_credits (BILLING READY)
    â”‚       â”‚   â”œâ”€â”€ error_message, error_traceback
    â”‚       â”‚   â””â”€â”€ timestamps: created_at, started_at, completed_at
    â”‚       â”‚
    â”‚       â”œâ”€â”€ AnalysisEvidence
    â”‚       â”‚   â”œâ”€â”€ analysis_job_id (FK)
    â”‚       â”‚   â”œâ”€â”€ evidence_type (Enum)
    â”‚       â”‚   â”œâ”€â”€ evidence_data (JSON)
    â”‚       â”‚   â”œâ”€â”€ vex_document_data (JSONB)
    â”‚       â”‚   â”œâ”€â”€ storage_path, file_size, checksum
    â”‚       â”‚   â””â”€â”€ created_at, description
    â”‚       â”‚
    â”‚       â”œâ”€â”€ JobStatus (Enum)
    â”‚       â””â”€â”€ EvidenceType (Enum)
    â”‚
    â”œâ”€â”€ workers/
    â”‚   â”œâ”€â”€ celery_app.py
    â”‚   â”‚   â”œâ”€â”€ Celery app configuration
    â”‚   â”‚   â”œâ”€â”€ Redis broker/backend: redis://localhost:6379/0
    â”‚   â”‚   â”œâ”€â”€ Task signals (prerun, postrun, failure)
    â”‚   â”‚   â””â”€â”€ Task time limits: 30min hard, 25min soft
    â”‚   â”‚
    â”‚   â”œâ”€â”€ tasks.py (Main orchestration - 400 lines)
    â”‚   â”‚   â”œâ”€â”€ AnalysisTask base class (error/success handling)
    â”‚   â”‚   â”‚
    â”‚   â”‚   â””â”€â”€ @celery_app.task: run_premium_analysis()
    â”‚   â”‚       Phase 1: Check Kubescape installed
    â”‚   â”‚       Phase 2: Deploy workload
    â”‚   â”‚       Phase 3: Wait for readiness
    â”‚   â”‚       Phase 3.5: Create K8s Service (if ports)
    â”‚   â”‚       Phase 3.6: Run OWASP ZAP scan (if fuzzing)
    â”‚   â”‚       Phase 4: Wait for Kubescape analysis
    â”‚   â”‚       Phase 5: Extract VEX + filtered SBOM
    â”‚   â”‚       Phase 6: Process VEX
    â”‚   â”‚       Phase 7: Generate summary
    â”‚   â”‚       Phase 8: Cleanup
    â”‚   â”‚       BILLING INTEGRATION POINT: After phase 8
    â”‚   â”‚
    â”‚   â”œâ”€â”€ tasks_impl.py (Legacy implementation)
    â”‚   â””â”€â”€ tasks_impl_kubescape.py (Helper functions)
    â”‚
    â”œâ”€â”€ services/
    â”‚   â”œâ”€â”€ __init__.py (Exports all services)
    â”‚   â”‚
    â”‚   â”œâ”€â”€ kubescape.py (450 lines)
    â”‚   â”‚   â”œâ”€â”€ KubescapeService class
    â”‚   â”‚   â”œâ”€â”€ Helm deployment
    â”‚   â”‚   â”œâ”€â”€ Namespace management
    â”‚   â”‚   â”œâ”€â”€ Workload deployment
    â”‚   â”‚   â”œâ”€â”€ VEX extraction from K8s CRDs
    â”‚   â”‚   â””â”€â”€ Filtered SBOM extraction
    â”‚   â”‚
    â”‚   â”œâ”€â”€ sandbox.py (320 lines)
    â”‚   â”‚   â”œâ”€â”€ SandboxManager class
    â”‚   â”‚   â”œâ”€â”€ Deployment creation
    â”‚   â”‚   â”œâ”€â”€ Resource limits enforcement
    â”‚   â”‚   â”œâ”€â”€ Readiness waiting
    â”‚   â”‚   â””â”€â”€ Cleanup
    â”‚   â”‚
    â”‚   â”œâ”€â”€ evidence.py (240 lines) - BILLING INTEGRATION POINT
    â”‚   â”‚   â”œâ”€â”€ EvidenceStorage class
    â”‚   â”‚   â”œâ”€â”€ store_evidence() - All evidence types
    â”‚   â”‚   â”œâ”€â”€ store_vex_document() - JSONB storage
    â”‚   â”‚   â”œâ”€â”€ retrieve_vex_by_id()
    â”‚   â”‚   â”œâ”€â”€ store_fuzzing_results()
    â”‚   â”‚   â””â”€â”€ store_filtered_sbom()
    â”‚   â”‚
    â”‚   â”œâ”€â”€ reachability.py (400 lines)
    â”‚   â”‚   â”œâ”€â”€ ReachabilityAnalyzer class
    â”‚   â”‚   â”œâ”€â”€ CVE-to-code mapping
    â”‚   â”‚   â”œâ”€â”€ Execution coverage analysis
    â”‚   â”‚   â””â”€â”€ Confidence scoring
    â”‚   â”‚
    â”‚   â”œâ”€â”€ owasp_zap.py (600 lines)
    â”‚   â”‚   â”œâ”€â”€ ZAPService class
    â”‚   â”‚   â”œâ”€â”€ OWASP ZAP integration
    â”‚   â”‚   â”œâ”€â”€ Endpoint fuzzing
    â”‚   â”‚   â””â”€â”€ SecurityFindings collection
    â”‚   â”‚
    â”‚   â”œâ”€â”€ sbom.py (240 lines)
    â”‚   â”‚   â”œâ”€â”€ SBOMService class
    â”‚   â”‚   â””â”€â”€ Filtered SBOM handling
    â”‚   â”‚
    â”‚   â””â”€â”€ profiler.py (320 lines)
    â”‚       â”œâ”€â”€ ProfilerService class
    â”‚       â”œâ”€â”€ eBPF profiling
    â”‚       â”œâ”€â”€ Execution trace parsing
    â”‚       â””â”€â”€ ExecutionProfile generation
    â”‚
    â”œâ”€â”€ middleware/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚
    â”‚   â”œâ”€â”€ error_handler.py
    â”‚   â”‚   â”œâ”€â”€ vexxy_exception_handler()
    â”‚   â”‚   â”œâ”€â”€ validation_error_handler()
    â”‚   â”‚   â””â”€â”€ Generic exception handling
    â”‚   â”‚
    â”‚   â”œâ”€â”€ logging_middleware.py
    â”‚   â”‚   â”œâ”€â”€ Structured logging setup
    â”‚   â”‚   â”œâ”€â”€ JSON logging support
    â”‚   â”‚   â””â”€â”€ Request/response logging
    â”‚   â”‚
    â”‚   â”œâ”€â”€ correlation_id.py
    â”‚   â”‚   â”œâ”€â”€ Request correlation tracking
    â”‚   â”‚   â””â”€â”€ ID propagation
    â”‚   â”‚
    â”‚   â””â”€â”€ [NEW] authentication.py (TO BE CREATED)
    â”‚       â”œâ”€â”€ JWT token validation
    â”‚       â”œâ”€â”€ Organization context extraction
    â”‚       â””â”€â”€ require_auth dependency
    â”‚
    â”œâ”€â”€ utils/
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”‚
    â”‚   â”œâ”€â”€ kubernetes_config.py
    â”‚   â”‚   â”œâ”€â”€ load_kubernetes_config()
    â”‚   â”‚   â””â”€â”€ Kubeconfig loading
    â”‚   â”‚
    â”‚   â”œâ”€â”€ retry.py
    â”‚   â”‚   â”œâ”€â”€ RetryConfig class
    â”‚   â”‚   â””â”€â”€ retry_with_backoff()
    â”‚   â”‚
    â”‚   â””â”€â”€ [NEW] quota.py (TO BE CREATED)
    â”‚       â”œâ”€â”€ check_quota()
    â”‚       â”œâ”€â”€ get_organization_tier()
    â”‚       â””â”€â”€ get_available_credits()
    â”‚
    â”œâ”€â”€ config/
    â”‚   â””â”€â”€ settings.py (Settings class)
    â”‚       â”œâ”€â”€ Service configuration
    â”‚       â”œâ”€â”€ Database settings
    â”‚       â”œâ”€â”€ Kubernetes settings
    â”‚       â”œâ”€â”€ JWT settings (unused)
    â”‚       â”œâ”€â”€ OWASP ZAP settings
    â”‚       â”œâ”€â”€ Storage settings
    â”‚       â””â”€â”€ [NEW TO ADD] Stripe settings, tier pricing
    â”‚
    â”œâ”€â”€ exceptions.py (Custom exception hierarchy - 240 lines)
    â”‚   â”œâ”€â”€ VexxyException (base)
    â”‚   â”œâ”€â”€ ValidationError (400)
    â”‚   â”œâ”€â”€ JobNotFoundError (404)
    â”‚   â”œâ”€â”€ InvalidJobStateError (409)
    â”‚   â”œâ”€â”€ QuotaExceededError (429) - READY TO USE
    â”‚   â”œâ”€â”€ InternalServiceError (500)
    â”‚   â”œâ”€â”€ DatabaseError (500)
    â”‚   â”œâ”€â”€ KubernetesError (502)
    â”‚   â”œâ”€â”€ KubescapeError (502)
    â”‚   â”œâ”€â”€ SandboxError (502)
    â”‚   â”œâ”€â”€ ServiceUnavailableError (503)
    â”‚   â”œâ”€â”€ TimeoutError (504)
    â”‚   â””â”€â”€ AnalysisTimeoutError (504)
    â”‚
    â”œâ”€â”€ migrations/
    â”‚   â”œâ”€â”€ 003_add_vex_jsonb_storage.sql
    â”‚   â””â”€â”€ add_security_findings.sql
    â”‚
    â”œâ”€â”€ k8s/
    â”‚   â”œâ”€â”€ namespace.yaml
    â”‚   â””â”€â”€ Other K8s manifests
    â”‚
    â”œâ”€â”€ scripts/
    â”‚   â”œâ”€â”€ Utility scripts
    â”‚   â””â”€â”€ Initialization scripts
    â”‚
    â””â”€â”€ tests/
        â””â”€â”€ [EMPTY - No tests yet]


DATABASE SCHEMA
===============

PostgreSQL (vexxy_premium)

Table: premium_analysis_jobs
â”œâ”€â”€ id (UUID PK)
â”œâ”€â”€ organization_id (UUID FK) â† NEEDS ORGANIZATION TABLE
â”œâ”€â”€ image_ref (VARCHAR)
â”œâ”€â”€ image_digest (VARCHAR)
â”œâ”€â”€ sbom_id (UUID)
â”œâ”€â”€ status (ENUM) - {queued, running, analyzing, complete, failed, cancelled}
â”œâ”€â”€ priority (INT)
â”œâ”€â”€ progress_percent (INT)
â”œâ”€â”€ current_phase (VARCHAR)
â”œâ”€â”€ execution_profile (JSON)
â”œâ”€â”€ reachability_results (JSON)
â”œâ”€â”€ security_findings (JSON)
â”œâ”€â”€ generated_vex_id (UUID)
â”œâ”€â”€ sandbox_id (VARCHAR)
â”œâ”€â”€ sandbox_job_name (VARCHAR)
â”œâ”€â”€ billed_at (TIMESTAMP) â† BILLING READY
â”œâ”€â”€ cost_credits (INT) â† BILLING READY
â”œâ”€â”€ created_at (TIMESTAMP)
â”œâ”€â”€ started_at (TIMESTAMP)
â”œâ”€â”€ completed_at (TIMESTAMP)
â”œâ”€â”€ error_message (TEXT)
â”œâ”€â”€ error_traceback (TEXT)
â””â”€â”€ retry_count (INT)

Table: analysis_evidence
â”œâ”€â”€ id (UUID PK)
â”œâ”€â”€ analysis_job_id (UUID FK)
â”œâ”€â”€ evidence_type (ENUM)
â”œâ”€â”€ evidence_data (JSON)
â”œâ”€â”€ storage_path (VARCHAR)
â”œâ”€â”€ file_size (BIGINT)
â”œâ”€â”€ checksum (VARCHAR)
â”œâ”€â”€ vex_document_data (JSONB) â† VEX storage
â”œâ”€â”€ created_at (TIMESTAMP)
â””â”€â”€ description (TEXT)

TABLES TO CREATE:
â”œâ”€â”€ organizations
â”œâ”€â”€ users
â”œâ”€â”€ subscriptions
â”œâ”€â”€ billing_events
â””â”€â”€ stripe_customers


DEPENDENCIES (requirements.txt)
================================

Current:
  - fastapi==0.104.1
  - uvicorn==0.24.0
  - pydantic==2.5.0
  - sqlalchemy==2.0.23
  - alembic==1.13.0
  - psycopg2-binary==2.9.9
  - celery[redis]==5.4.0
  - redis==5.2.0
  - flower==2.0.1
  - kubernetes==28.1.0
  - httpx==0.25.2
  - python-jose[cryptography]==3.3.0
  - passlib[bcrypt]==1.7.4
  - python-owasp-zap-v2.4==0.0.21
  - prometheus-client==0.19.0
  - python-dateutil==2.8.2

To Add for Billing:
  - stripe==5.18.0           â† PRIMARY
  - pyjwt==2.8.1             â† if upgrading auth


KEY FINDINGS
============

âœ… STRENGTHS:
- FastAPI modern, async-first framework
- Clean architecture: API â†’ Workers â†’ Services â†’ Data
- Celery for scalable async processing
- Professional error handling
- Structured logging
- Kubernetes-native design
- Database schema ready for billing

âš ï¸ GAPS:
- ZERO authentication/authorization
- No Organization/User/Subscription models
- No Stripe integration
- No billing ledger/events
- No quota enforcement
- Only dummy hardcoded organization_id

ğŸ¯ INTEGRATION POINTS:
1. Authentication middleware (new)
2. Quota checking in submit_analysis()
3. Cost calculation in task completion
4. Webhook processing (new)
5. Billing API endpoints (new)

ğŸ“Š CODE STATISTICS:
- Total Python files: 30
- Lines of code: ~3,500
- Main files: api/main.py (650), services/kubescape.py (450), workers/tasks.py (400)
- Languages: Python (FastAPI), SQL (migrations), YAML (K8s manifests)

